<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Surviving The Worldâ„¢ - AAA Medieval Survival</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a15;font-family:'Segoe UI',Arial,sans-serif;overflow:hidden;color:#fff}
#menu{position:fixed;inset:0;background:linear-gradient(135deg,#0a0a15 0%,#1a1a2e 50%,#0a0a15 100%);
display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000}
.logo{font-size:3.5em;color:#ffd700;text-shadow:0 0 40px rgba(255,215,0,0.6),0 4px 8px rgba(0,0,0,0.8);margin-bottom:10px;font-weight:bold}
.subtitle{color:#888;margin-bottom:40px;letter-spacing:3px;font-size:14px}
.chars{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;max-width:900px}
.char{width:150px;padding:25px 15px;background:linear-gradient(180deg,#1a1a2e,#12121f);border:2px solid #333;border-radius:15px;
cursor:pointer;text-align:center;transition:all .3s ease}
.char:hover{border-color:#ffd700;transform:translateY(-8px);box-shadow:0 15px 40px rgba(255,215,0,0.3)}
.char img{width:60px;height:60px;margin-bottom:12px;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.5))}
.char .name{font-weight:bold;font-size:16px;margin-bottom:8px;color:#fff}
.char .stats{color:#888;font-size:11px;line-height:1.4}
.hint{color:#555;margin-top:40px;font-size:12px}
#game{display:none;position:fixed;inset:0}
#gameCanvas{width:100%;height:100%;display:block}
#hud{position:fixed;top:20px;left:20px;z-index:100}
.stat{margin-bottom:10px;display:flex;align-items:center;gap:10px}
.stat-icon{font-size:18px}
.stat-bar{width:160px;height:18px;background:rgba(0,0,0,0.6);border-radius:9px;overflow:hidden;border:1px solid #333}
.stat-fill{height:100%;border-radius:8px;transition:width .3s}
.hp-fill{background:linear-gradient(90deg,#8B0000,#e74c3c)}
.st-fill{background:linear-gradient(90deg,#1a5f2a,#2ecc71)}
.hu-fill{background:linear-gradient(90deg,#8B4513,#e67e22)}
.stat-text{font-size:11px;color:#aaa;min-width:50px}
#info{position:fixed;top:20px;right:20px;text-align:right;z-index:100}
#day{font-size:20px;color:#ffd700;font-weight:bold;text-shadow:0 2px 4px rgba(0,0,0,0.5)}
#weather{font-size:13px;color:#aaa;margin-top:5px}
#heat{margin-top:15px;font-size:12px}
.heat-row{margin:5px 0;display:flex;align-items:center;justify-content:flex-end;gap:8px}
.heat-tag{padding:4px 12px;border-radius:12px;font-size:11px;font-weight:bold}
.calm{background:#27ae60;color:#fff}.alert{background:#f39c12;color:#000}.hunting{background:#e74c3c;color:#fff}
#minimap{position:fixed;bottom:20px;right:20px;width:180px;height:180px;background:rgba(0,0,0,0.8);border:3px solid #ffd700;border-radius:10px;z-index:100}
#log{position:fixed;bottom:20px;left:20px;width:320px;max-height:180px;background:rgba(0,0,0,0.8);border-radius:10px;padding:12px;z-index:100;overflow-y:auto}
#log-title{color:#ffd700;margin-bottom:8px;font-weight:bold;font-size:13px}
.log-entry{padding:4px 0;border-bottom:1px solid #222;color:#aaa;font-size:12px}
.log-combat{color:#e74c3c}.log-quest{color:#ffd700}.log-ai{color:#3498db}.log-system{color:#2ecc71}
#controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:10px 25px;border-radius:25px;z-index:100;font-size:12px;color:#666}
#crosshair{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:20px;height:20px;z-index:100;pointer-events:none;opacity:0.5}
#crosshair::before,#crosshair::after{content:'';position:absolute;background:#fff}
#crosshair::before{width:2px;height:20px;left:9px}
#crosshair::after{width:20px;height:2px;top:9px}
</style>
</head>
<body>
<div id="menu">
<div class="logo">âš”ï¸ SURVIVING THE WORLDâ„¢</div>
<div class="subtitle">AAA MEDIEVAL SURVIVAL EXPERIENCE</div>
<div class="chars">
<div class="char" onclick="startGame(0)"><img src="https://em-content.zobj.net/source/twitter/376/crossed-swords_2694-fe0f.png" alt="Warrior"><div class="name">Warrior</div><div class="stats">HP: 150 | DMG: 25<br>Speed: 5 | Armor: High</div></div>
<div class="char" onclick="startGame(1)"><img src="https://em-content.zobj.net/source/twitter/376/bow-and-arrow_1f3f9.png" alt="Ranger"><div class="name">Ranger</div><div class="stats">HP: 100 | DMG: 20<br>Speed: 7 | Perception+</div></div>
<div class="char" onclick="startGame(2)"><img src="https://em-content.zobj.net/source/twitter/376/ninja_1f977.png" alt="Assassin"><div class="name">Assassin</div><div class="stats">HP: 80 | DMG: 35<br>Speed: 9 | Stealth+</div></div>
<div class="char" onclick="startGame(3)"><img src="https://em-content.zobj.net/source/twitter/376/shield_1f6e1-fe0f.png" alt="Tank"><div class="name">Tank</div><div class="stats">HP: 200 | DMG: 15<br>Speed: 4 | Armor: Max</div></div>
<div class="char" onclick="startGame(4)"><img src="https://em-content.zobj.net/source/twitter/376/mage_1f9d9.png" alt="Survivor"><div class="name">Survivor</div><div class="stats">HP: 120 | DMG: 18<br>Speed: 5 | Hunger-</div></div>
</div>
<div class="hint">WASD = Move | Mouse = Look | SHIFT = Run | E = Interact | Q = Attack | Click to Start</div>
</div>
<div id="game">
<canvas id="gameCanvas"></canvas>
<div id="crosshair"></div>
<div id="hud">
<div class="stat"><span class="stat-icon">â¤ï¸</span><div class="stat-bar"><div class="stat-fill hp-fill" id="hp"></div></div><span class="stat-text" id="hp-text">150/150</span></div>
<div class="stat"><span class="stat-icon">âš¡</span><div class="stat-bar"><div class="stat-fill st-fill" id="st"></div></div><span class="stat-text" id="st-text">100%</span></div>
<div class="stat"><span class="stat-icon">ğŸ–</span><div class="stat-bar"><div class="stat-fill hu-fill" id="hu"></div></div><span class="stat-text" id="hu-text">80%</span></div>
</div>
<div id="info">
<div id="day">Day 1 | 06:00</div>
<div id="weather">â˜€ï¸ Clear | 22Â°C</div>
<div id="heat">
<div class="heat-row">Kingdom <span class="heat-tag calm" id="h-kingdom">CALM</span></div>
<div class="heat-row">Bandits <span class="heat-tag alert" id="h-bandits">ALERT</span></div>
</div>
</div>
<canvas id="minimap" width="180" height="180"></canvas>
<div id="log"><div id="log-title">ğŸ“œ ADVENTURE LOG</div><div id="log-entries"></div></div>
<div id="controls">WASD Move | Mouse Look | SHIFT Sprint | E Interact | Q Attack | ESC Menu</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SURVIVING THE WORLDâ„¢ - AAA GAME ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let scene, camera, renderer, clock;
let player, playerYaw = 0, playerPitch = 0;
let keys = {}, enemies = [], npcs = [], items = [], buildings = [];
let hp = 100, maxHp = 100, stamina = 100, hunger = 80;
let day = 1, gameTime = 6;
let heat = { kingdom: 0, bandits: 25 };
let isLocked = false;

const CHARS = [
  { name: 'Warrior', color: 0xe74c3c, hp: 150, spd: 5, dmg: 25, armor: 0.3 },
  { name: 'Ranger', color: 0x27ae60, hp: 100, spd: 7, dmg: 20, armor: 0.1 },
  { name: 'Assassin', color: 0x9b59b6, hp: 80, spd: 9, dmg: 35, armor: 0.05 },
  { name: 'Tank', color: 0x3498db, hp: 200, spd: 4, dmg: 15, armor: 0.5 },
  { name: 'Survivor', color: 0xf39c12, hp: 120, spd: 5, dmg: 18, armor: 0.2 }
];
let cfg;

window.startGame = function(i) {
  cfg = CHARS[i];
  hp = cfg.hp;
  maxHp = cfg.hp;
  document.getElementById('menu').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  initGame();
};

function initGame() {
  const canvas = document.getElementById('gameCanvas');
  
  // Scene with sky gradient
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87CEEB);
  scene.fog = new THREE.FogExp2(0x87CEEB, 0.003);
  
  // Camera
  camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
  
  // Renderer with high quality
  renderer = new THREE.WebGLRenderer({ canvas, antialias: true, powerPreference: 'high-performance' });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.2;
  
  // Lighting - AAA quality
  const ambient = new THREE.AmbientLight(0x404080, 0.4);
  scene.add(ambient);
  
  const sun = new THREE.DirectionalLight(0xffffcc, 1.2);
  sun.position.set(100, 150, 50);
  sun.castShadow = true;
  sun.shadow.mapSize.width = 2048;
  sun.shadow.mapSize.height = 2048;
  sun.shadow.camera.near = 10;
  sun.shadow.camera.far = 500;
  sun.shadow.camera.left = -150;
  sun.shadow.camera.right = 150;
  sun.shadow.camera.top = 150;
  sun.shadow.camera.bottom = -150;
  sun.shadow.bias = -0.0001;
  scene.add(sun);
  
  const hemi = new THREE.HemisphereLight(0x87CEEB, 0x3d6b2e, 0.6);
  scene.add(hemi);

  // Ground with texture
  const groundGeo = new THREE.PlaneGeometry(600, 600, 50, 50);
  const groundMat = new THREE.MeshStandardMaterial({ 
    color: 0x3d6b2e, 
    roughness: 0.9,
    metalness: 0.0
  });
  const ground = new THREE.Mesh(groundGeo, groundMat);
  ground.rotation.x = -Math.PI / 2;
  ground.receiveShadow = true;
  scene.add(ground);
  
  // Main roads
  createRoad(0, 0, 600, 15);
  createRoad(0, 0, 15, 600);
  createRoad(-100, 100, 200, 10);
  createRoad(100, -100, 10, 200);
  
  // Village buildings
  createBuilding(-60, -60, 25, 20, 25, 0x8B4513, 'The Golden Tavern');
  createBuilding(70, -50, 30, 24, 30, 0x4a4a4a, 'Ironforge Smithy');
  createBuilding(-80, 60, 40, 35, 35, 0x2c3e50, 'Castle Keep');
  createBuilding(90, 70, 22, 16, 22, 0x8B7355, 'Market Square');
  createBuilding(0, -120, 25, 22, 30, 0x4a4a4a, 'Church of Light');
  
  // Houses
  for (let i = 0; i < 12; i++) {
    const x = (Math.random() - 0.5) * 400;
    const z = (Math.random() - 0.5) * 400;
    if (Math.abs(x) > 50 || Math.abs(z) > 50) {
      createBuilding(x, z, 14 + Math.random() * 6, 12 + Math.random() * 4, 14 + Math.random() * 6, 0x654321, 'Village House');
    }
  }
  
  // Forest
  for (let i = 0; i < 100; i++) {
    const x = (Math.random() - 0.5) * 500;
    const z = (Math.random() - 0.5) * 500;
    if (Math.abs(x) > 35 || Math.abs(z) > 35) {
      createTree(x, z);
    }
  }
  
  // Rocks
  for (let i = 0; i < 40; i++) {
    const x = (Math.random() - 0.5) * 500;
    const z = (Math.random() - 0.5) * 500;
    createRock(x, z);
  }
  
  // Player character
  createPlayer();
  
  // Enemies with AI
  const enemyTypes = [
    { name: 'Bandit Scout', color: 0x8B0000, hp: 50, dmg: 8, spd: 4, hostile: true },
    { name: 'Bandit Raider', color: 0xB22222, hp: 80, dmg: 12, spd: 3, hostile: true },
    { name: 'Kingdom Guard', color: 0x4169E1, hp: 100, dmg: 10, spd: 3, hostile: false },
    { name: 'Wild Wolf', color: 0x555555, hp: 40, dmg: 15, spd: 6, hostile: true }
  ];
  
  for (let i = 0; i < 15; i++) {
    const x = (Math.random() - 0.5) * 350;
    const z = (Math.random() - 0.5) * 350;
    if (Math.abs(x) > 40 || Math.abs(z) > 40) {
      const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
      createEnemy(x, z, type);
    }
  }
  
  // NPCs
  createNPC(-55, -55, 'Merchant Aldric', 0xDAA520, 'trade');
  createNPC(75, -45, 'Blacksmith Gorn', 0x708090, 'craft');
  createNPC(-75, 65, 'Lord Commander', 0x9370DB, 'quest');
  createNPC(0, -115, 'Healer Miriam', 0x98FB98, 'heal');
  createNPC(95, 75, 'Trader Marcus', 0xDEB887, 'trade');
  
  // Collectible items
  for (let i = 0; i < 30; i++) {
    const x = (Math.random() - 0.5) * 400;
    const z = (Math.random() - 0.5) * 400;
    createItem(x, z);
  }
  
  // Controls
  setupControls(canvas);
  
  clock = new THREE.Clock();
  log('Welcome, ' + cfg.name + '! Your adventure begins...', 'system');
  log('Explore the village, talk to NPCs, survive!', 'system');
  
  gameLoop();
}

function createRoad(x, z, w, d) {
  const geo = new THREE.PlaneGeometry(w, d);
  const mat = new THREE.MeshStandardMaterial({ color: 0x3a3a3a, roughness: 0.95 });
  const road = new THREE.Mesh(geo, mat);
  road.rotation.x = -Math.PI / 2;
  road.position.set(x, 0.02, z);
  road.receiveShadow = true;
  scene.add(road);
}

function createBuilding(x, z, w, h, d, color, name) {
  const group = new THREE.Group();
  
  // Main structure
  const bodyGeo = new THREE.BoxGeometry(w, h, d);
  const bodyMat = new THREE.MeshStandardMaterial({ color, roughness: 0.8 });
  const body = new THREE.Mesh(bodyGeo, bodyMat);
  body.position.y = h / 2;
  body.castShadow = true;
  body.receiveShadow = true;
  group.add(body);
  
  // Roof
  const roofGeo = new THREE.ConeGeometry(Math.max(w, d) * 0.75, h * 0.4, 4);
  const roofMat = new THREE.MeshStandardMaterial({ color: 0x8B0000, roughness: 0.7 });
  const roof = new THREE.Mesh(roofGeo, roofMat);
  roof.position.y = h + h * 0.2;
  roof.rotation.y = Math.PI / 4;
  roof.castShadow = true;
  group.add(roof);
  
  // Door
  const doorGeo = new THREE.BoxGeometry(w * 0.2, h * 0.4, 0.3);
  const doorMat = new THREE.MeshStandardMaterial({ color: 0x3d2817 });
  const door = new THREE.Mesh(doorGeo, doorMat);
  door.position.set(0, h * 0.2, d / 2 + 0.1);
  group.add(door);
  
  // Windows
  const winGeo = new THREE.BoxGeometry(w * 0.15, h * 0.15, 0.2);
  const winMat = new THREE.MeshStandardMaterial({ color: 0x87CEEB, emissive: 0x222244, emissiveIntensity: 0.3 });
  [-1, 1].forEach(side => {
    const win = new THREE.Mesh(winGeo, winMat);
    win.position.set(side * w * 0.3, h * 0.6, d / 2 + 0.1);
    group.add(win);
  });
  
  group.position.set(x, 0, z);
  group.userData = { type: 'building', name };
  scene.add(group);
  buildings.push(group);
}

function createTree(x, z) {
  const group = new THREE.Group();
  const scale = 0.8 + Math.random() * 0.6;
  
  // Trunk
  const trunkGeo = new THREE.CylinderGeometry(0.3 * scale, 0.5 * scale, 5 * scale, 8);
  const trunkMat = new THREE.MeshStandardMaterial({ color: 0x4a3728, roughness: 0.9 });
  const trunk = new THREE.Mesh(trunkGeo, trunkMat);
  trunk.position.y = 2.5 * scale;
  trunk.castShadow = true;
  group.add(trunk);
  
  // Foliage layers
  const colors = [0x228B22, 0x2d8f2d, 0x1e7a1e];
  for (let i = 0; i < 3; i++) {
    const foliageGeo = new THREE.SphereGeometry((3 - i * 0.5) * scale, 8, 6);
    const foliageMat = new THREE.MeshStandardMaterial({ color: colors[i], roughness: 0.8 });
    const foliage = new THREE.Mesh(foliageGeo, foliageMat);
    foliage.position.y = (5 + i * 1.5) * scale;
    foliage.castShadow = true;
    group.add(foliage);
  }
  
  group.position.set(x, 0, z);
  scene.add(group);
}

function createRock(x, z) {
  const size = 0.5 + Math.random() * 2;
  const geo = new THREE.DodecahedronGeometry(size, 0);
  const mat = new THREE.MeshStandardMaterial({ color: 0x666666, roughness: 0.95 });
  const rock = new THREE.Mesh(geo, mat);
  rock.position.set(x, size * 0.4, z);
  rock.rotation.set(Math.random(), Math.random(), Math.random());
  rock.castShadow = true;
  scene.add(rock);
}

function createPlayer() {
  const group = new THREE.Group();
  
  // Body (cylinder instead of capsule for compatibility)
  const bodyGeo = new THREE.CylinderGeometry(0.35, 0.4, 1.4, 12);
  const bodyMat = new THREE.MeshStandardMaterial({ color: cfg.color, roughness: 0.6 });
  const body = new THREE.Mesh(bodyGeo, bodyMat);
  body.position.y = 0.7;
  body.castShadow = true;
  group.add(body);
  
  // Head
  const headGeo = new THREE.SphereGeometry(0.25, 12, 8);
  const headMat = new THREE.MeshStandardMaterial({ color: 0xffdbac, roughness: 0.7 });
  const head = new THREE.Mesh(headGeo, headMat);
  head.position.y = 1.6;
  head.castShadow = true;
  group.add(head);
  
  player = group;
  player.position.set(0, 0, 0);
  scene.add(player);
}

function createEnemy(x, z, type) {
  const group = new THREE.Group();
  
  // Body
  const bodyGeo = new THREE.CylinderGeometry(0.35, 0.4, 1.2, 8);
  const bodyMat = new THREE.MeshStandardMaterial({ color: type.color, roughness: 0.7 });
  const body = new THREE.Mesh(bodyGeo, bodyMat);
  body.position.y = 0.6;
  body.castShadow = true;
  group.add(body);
  
  // Head
  const headGeo = new THREE.SphereGeometry(0.22, 8, 6);
  const headMat = new THREE.MeshStandardMaterial({ color: type.hostile ? 0x8B0000 : 0x4169E1, roughness: 0.7 });
  const head = new THREE.Mesh(headGeo, headMat);
  head.position.y = 1.4;
  group.add(head);
  
  // Health bar background
  const hpBgGeo = new THREE.PlaneGeometry(1.2, 0.12);
  const hpBgMat = new THREE.MeshBasicMaterial({ color: 0x333333, side: THREE.DoubleSide });
  const hpBg = new THREE.Mesh(hpBgGeo, hpBgMat);
  hpBg.position.y = 2;
  group.add(hpBg);
  
  // Health bar fill
  const hpGeo = new THREE.PlaneGeometry(1.18, 0.1);
  const hpMat = new THREE.MeshBasicMaterial({ color: 0xff0000, side: THREE.DoubleSide });
  const hpBar = new THREE.Mesh(hpGeo, hpMat);
  hpBar.position.y = 2;
  hpBar.position.z = 0.01;
  group.add(hpBar);
  
  group.position.set(x, 0, z);
  group.userData = {
    type: 'enemy',
    enemyType: type,
    hp: type.hp,
    maxHp: type.hp,
    state: 'patrol',
    vx: (Math.random() - 0.5) * 2,
    vz: (Math.random() - 0.5) * 2,
    alertLevel: 0,
    hpBar: hpBar
  };
  
  scene.add(group);
  enemies.push(group);
}

function createNPC(x, z, name, color, role) {
  const group = new THREE.Group();
  
  // Body
  const bodyGeo = new THREE.CylinderGeometry(0.3, 0.35, 1.3, 10);
  const bodyMat = new THREE.MeshStandardMaterial({ color, roughness: 0.6 });
  const body = new THREE.Mesh(bodyGeo, bodyMat);
  body.position.y = 0.65;
  body.castShadow = true;
  group.add(body);
  
  // Head
  const headGeo = new THREE.SphereGeometry(0.2, 10, 8);
  const headMat = new THREE.MeshStandardMaterial({ color: 0xffdbac, roughness: 0.7 });
  const head = new THREE.Mesh(headGeo, headMat);
  head.position.y = 1.5;
  group.add(head);
  
  // Quest indicator
  const indGeo = new THREE.OctahedronGeometry(0.15, 0);
  const indMat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
  const indicator = new THREE.Mesh(indGeo, indMat);
  indicator.position.y = 2;
  group.add(indicator);
  group.userData.indicator = indicator;
  
  group.position.set(x, 0, z);
  group.userData.type = 'npc';
  group.userData.name = name;
  group.userData.role = role;
  
  scene.add(group);
  npcs.push(group);
}

function createItem(x, z) {
  const types = [
    { name: 'Apple', color: 0xff0000, effect: 'hunger', value: 15, emissive: 0x330000 },
    { name: 'Bread', color: 0xdaa520, effect: 'hunger', value: 25, emissive: 0x332200 },
    { name: 'Health Potion', color: 0xff00ff, effect: 'health', value: 40, emissive: 0x330033 },
    { name: 'Gold Coin', color: 0xffd700, effect: 'gold', value: 10, emissive: 0x333300 },
    { name: 'Iron Sword', color: 0xc0c0c0, effect: 'weapon', value: 5, emissive: 0x222222 }
  ];
  const type = types[Math.floor(Math.random() * types.length)];
  
  const geo = new THREE.OctahedronGeometry(0.3, 0);
  const mat = new THREE.MeshStandardMaterial({ 
    color: type.color, 
    emissive: type.emissive,
    emissiveIntensity: 0.5,
    roughness: 0.3,
    metalness: 0.5
  });
  const item = new THREE.Mesh(geo, mat);
  item.position.set(x, 0.5, z);
  item.userData = { type: 'item', itemType: type, collected: false };
  scene.add(item);
  items.push(item);
}

function setupControls(canvas) {
  document.addEventListener('keydown', e => { 
    keys[e.code] = true;
    if (e.code === 'KeyE') handleInteract();
    if (e.code === 'KeyQ') handleAttack();
  });
  document.addEventListener('keyup', e => { keys[e.code] = false; });
  
  document.addEventListener('mousemove', e => {
    if (isLocked) {
      playerYaw -= e.movementX * 0.002;
      playerPitch -= e.movementY * 0.002;
      playerPitch = Math.max(-1.2, Math.min(1.2, playerPitch));
    }
  });
  
  canvas.addEventListener('click', () => {
    canvas.requestPointerLock();
  });
  
  document.addEventListener('pointerlockchange', () => {
    isLocked = document.pointerLockElement === canvas;
  });
  
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
}

function handleInteract() {
  // NPCs
  for (const npc of npcs) {
    const dist = player.position.distanceTo(npc.position);
    if (dist < 4) {
      const dialogs = {
        trade: '"Welcome! I have fine wares for sale."',
        craft: '"Need something forged? I am the best smith in the land!"',
        quest: '"Brave adventurer! The bandits threaten our village. Will you help?"',
        heal: '"Blessings upon you. Let me tend to your wounds."'
      };
      log(npc.userData.name + ': ' + dialogs[npc.userData.role], 'ai');
      if (npc.userData.role === 'heal' && hp < maxHp) {
        hp = Math.min(maxHp, hp + 50);
        log('You feel rejuvenated! +50 HP', 'system');
      }
      return;
    }
  }
  
  // Items
  for (const item of items) {
    if (item.userData.collected) continue;
    const dist = player.position.distanceTo(item.position);
    if (dist < 3) {
      item.userData.collected = true;
      item.visible = false;
      const type = item.userData.itemType;
      log('Collected: ' + type.name, 'quest');
      
      if (type.effect === 'hunger') hunger = Math.min(100, hunger + type.value);
      if (type.effect === 'health') hp = Math.min(maxHp, hp + type.value);
      return;
    }
  }
}

function handleAttack() {
  for (const enemy of enemies) {
    if (enemy.userData.hp <= 0) continue;
    const dist = player.position.distanceTo(enemy.position);
    if (dist < 4) {
      const dmg = cfg.dmg + Math.floor(Math.random() * 5);
      enemy.userData.hp -= dmg;
      log('Hit ' + enemy.userData.enemyType.name + ' for ' + dmg + ' damage!', 'combat');
      
      // Update health bar
      const hpPercent = Math.max(0, enemy.userData.hp / enemy.userData.maxHp);
      enemy.userData.hpBar.scale.x = hpPercent;
      
      // Aggro
      enemy.userData.state = 'chase';
      enemy.userData.alertLevel = 100;
      
      if (enemy.userData.hp <= 0) {
        log(enemy.userData.enemyType.name + ' defeated!', 'combat');
        heat.bandits = Math.min(100, heat.bandits + 10);
      }
      return;
    }
  }
}

function gameLoop() {
  requestAnimationFrame(gameLoop);
  const dt = Math.min(clock.getDelta(), 0.05);
  
  // Player movement
  let moveX = 0, moveZ = 0;
  if (keys.KeyW || keys.ArrowUp) moveZ = -1;
  if (keys.KeyS || keys.ArrowDown) moveZ = 1;
  if (keys.KeyA || keys.ArrowLeft) moveX = -1;
  if (keys.KeyD || keys.ArrowRight) moveX = 1;
  
  const running = keys.ShiftLeft && stamina > 0;
  const speed = (running ? cfg.spd * 1.8 : cfg.spd) * dt;
  
  if (moveX || moveZ) {
    const angle = Math.atan2(moveX, moveZ) + playerYaw;
    player.position.x += Math.sin(angle) * speed;
    player.position.z += Math.cos(angle) * speed;
    if (running) stamina = Math.max(0, stamina - 20 * dt);
  }
  
  // Stamina regen
  if (!running) stamina = Math.min(100, stamina + 12 * dt);
  
  // Hunger decay
  hunger = Math.max(0, hunger - 0.2 * dt);
  if (hunger <= 0) hp -= dt * 3;
  
  // Bounds
  player.position.x = Math.max(-280, Math.min(280, player.position.x));
  player.position.z = Math.max(-280, Math.min(280, player.position.z));
  player.rotation.y = playerYaw;
  
  // Camera - third person
  const camDist = 6;
  const camHeight = 3;
  camera.position.x = player.position.x - Math.sin(playerYaw) * camDist;
  camera.position.y = player.position.y + camHeight;
  camera.position.z = player.position.z - Math.cos(playerYaw) * camDist;
  camera.lookAt(player.position.x, player.position.y + 1.5, player.position.z);
  
  // Enemy AI
  updateEnemies(dt);
  
  // NPC indicators bob
  npcs.forEach(npc => {
    if (npc.userData.indicator) {
      npc.userData.indicator.rotation.y += dt * 2;
      npc.userData.indicator.position.y = 2 + Math.sin(Date.now() * 0.003) * 0.1;
    }
  });
  
  // Items bob and spin
  items.forEach(item => {
    if (!item.userData.collected) {
      item.position.y = 0.5 + Math.sin(Date.now() * 0.003 + item.position.x) * 0.15;
      item.rotation.y += dt * 1.5;
      item.rotation.x += dt * 0.5;
    }
  });
  
  // Time progression
  gameTime += dt * 0.05;
  if (gameTime >= 24) { gameTime = 0; day++; log('Day ' + day + ' dawns...', 'system'); }
  
  // Heat decay
  heat.kingdom = Math.max(0, heat.kingdom - 0.15 * dt);
  heat.bandits = Math.max(0, heat.bandits - 0.15 * dt);
  
  // Update HUD
  updateHUD();
  updateMinimap();
  
  // Death check
  if (hp <= 0) {
    log('You have fallen! Respawning...', 'combat');
    hp = maxHp;
    stamina = 100;
    player.position.set(0, 0, 0);
  }
  
  renderer.render(scene, camera);
}

function updateEnemies(dt) {
  enemies.forEach(enemy => {
    if (enemy.userData.hp <= 0) {
      enemy.visible = false;
      return;
    }
    
    const data = enemy.userData;
    const type = data.enemyType;
    const dist = player.position.distanceTo(enemy.position);
    
    // Face health bar to camera
    if (enemy.children[2]) enemy.children[2].lookAt(camera.position);
    if (enemy.children[3]) enemy.children[3].lookAt(camera.position);
    
    // AI State machine
    if (type.hostile) {
      if (dist < 35 && dist > 2.5) {
        // Chase
        const dir = player.position.clone().sub(enemy.position).normalize();
        enemy.position.x += dir.x * type.spd * dt;
        enemy.position.z += dir.z * type.spd * dt;
        enemy.lookAt(player.position.x, enemy.position.y, player.position.z);
        data.state = 'chase';
      } else if (dist <= 2.5) {
        // Attack
        if (Math.random() < dt * 1.5) {
          const dmg = Math.max(1, type.dmg - Math.floor(cfg.armor * type.dmg));
          hp -= dmg;
          log(type.name + ' hits you for ' + dmg + ' damage!', 'combat');
        }
        data.state = 'attack';
      } else {
        // Patrol
        enemy.position.x += data.vx * dt;
        enemy.position.z += data.vz * dt;
        if (Math.abs(enemy.position.x) > 150) data.vx *= -1;
        if (Math.abs(enemy.position.z) > 150) data.vz *= -1;
        data.state = 'patrol';
      }
    } else {
      // Non-hostile patrol
      enemy.position.x += data.vx * 0.5 * dt;
      enemy.position.z += data.vz * 0.5 * dt;
      if (Math.abs(enemy.position.x) > 100) data.vx *= -1;
      if (Math.abs(enemy.position.z) > 100) data.vz *= -1;
    }
  });
}

function updateHUD() {
  document.getElementById('hp').style.width = (hp / maxHp * 100) + '%';
  document.getElementById('st').style.width = stamina + '%';
  document.getElementById('hu').style.width = hunger + '%';
  document.getElementById('hp-text').textContent = Math.floor(hp) + '/' + maxHp;
  document.getElementById('st-text').textContent = Math.floor(stamina) + '%';
  document.getElementById('hu-text').textContent = Math.floor(hunger) + '%';
  
  const hours = Math.floor(gameTime);
  const mins = Math.floor((gameTime % 1) * 60);
  document.getElementById('day').textContent = 'Day ' + day + ' | ' + 
    String(hours).padStart(2, '0') + ':' + String(mins).padStart(2, '0');
  
  // Weather based on time
  let weather = 'â˜€ï¸ Clear';
  if (gameTime < 6 || gameTime > 20) weather = 'ğŸŒ™ Night';
  else if (gameTime > 18) weather = 'ğŸŒ… Sunset';
  else if (gameTime < 8) weather = 'ğŸŒ„ Dawn';
  document.getElementById('weather').textContent = weather + ' | 22Â°C';
  
  // Heat levels
  const hk = document.getElementById('h-kingdom');
  const hb = document.getElementById('h-bandits');
  hk.textContent = heat.kingdom < 25 ? 'CALM' : heat.kingdom < 50 ? 'ALERT' : 'HUNTING';
  hk.className = 'heat-tag ' + (heat.kingdom < 25 ? 'calm' : heat.kingdom < 50 ? 'alert' : 'hunting');
  hb.textContent = heat.bandits < 25 ? 'CALM' : heat.bandits < 50 ? 'ALERT' : 'HUNTING';
  hb.className = 'heat-tag ' + (heat.bandits < 25 ? 'calm' : heat.bandits < 50 ? 'alert' : 'hunting');
}

function updateMinimap() {
  const canvas = document.getElementById('minimap');
  const ctx = canvas.getContext('2d');
  const size = 180;
  const scale = 0.35;
  
  // Background
  ctx.fillStyle = '#0a0a15';
  ctx.fillRect(0, 0, size, size);
  
  // Grid
  ctx.strokeStyle = '#1a1a2e';
  ctx.lineWidth = 1;
  for (let i = 0; i < size; i += 30) {
    ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, size); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(size, i); ctx.stroke();
  }
  
  const px = player.position.x;
  const pz = player.position.z;
  
  // Buildings
  ctx.fillStyle = '#4a4a4a';
  buildings.forEach(b => {
    const x = size/2 + (b.position.x - px) * scale;
    const z = size/2 + (b.position.z - pz) * scale;
    if (x > 5 && x < size-5 && z > 5 && z < size-5) {
      ctx.fillRect(x - 5, z - 5, 10, 10);
    }
  });
  
  // Enemies
  enemies.forEach(e => {
    if (e.userData.hp <= 0) return;
    const x = size/2 + (e.position.x - px) * scale;
    const z = size/2 + (e.position.z - pz) * scale;
    if (x > 0 && x < size && z > 0 && z < size) {
      ctx.fillStyle = e.userData.enemyType.hostile ? '#ff4444' : '#4488ff';
      ctx.beginPath(); ctx.arc(x, z, 4, 0, Math.PI * 2); ctx.fill();
    }
  });
  
  // NPCs
  ctx.fillStyle = '#44ff44';
  npcs.forEach(n => {
    const x = size/2 + (n.position.x - px) * scale;
    const z = size/2 + (n.position.z - pz) * scale;
    if (x > 0 && x < size && z > 0 && z < size) {
      ctx.beginPath(); ctx.arc(x, z, 4, 0, Math.PI * 2); ctx.fill();
    }
  });
  
  // Items
  ctx.fillStyle = '#ffff44';
  items.forEach(i => {
    if (i.userData.collected) return;
    const x = size/2 + (i.position.x - px) * scale;
    const z = size/2 + (i.position.z - pz) * scale;
    if (x > 0 && x < size && z > 0 && z < size) {
      ctx.fillRect(x - 2, z - 2, 4, 4);
    }
  });
  
  // Player
  ctx.fillStyle = '#ffd700';
  ctx.beginPath(); ctx.arc(size/2, size/2, 6, 0, Math.PI * 2); ctx.fill();
  
  // Direction
  ctx.strokeStyle = '#ffd700';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(size/2, size/2);
  ctx.lineTo(size/2 - Math.sin(playerYaw) * 18, size/2 - Math.cos(playerYaw) * 18);
  ctx.stroke();
}

function log(msg, type = 'system') {
  const el = document.getElementById('log-entries');
  const div = document.createElement('div');
  div.className = 'log-entry log-' + type;
  const hours = Math.floor(gameTime);
  const mins = Math.floor((gameTime % 1) * 60);
  div.textContent = '[' + String(hours).padStart(2, '0') + ':' + String(mins).padStart(2, '0') + '] ' + msg;
  el.insertBefore(div, el.firstChild);
  while (el.children.length > 20) el.removeChild(el.lastChild);
}

console.log('âš”ï¸ Surviving The Worldâ„¢ - AAA Game Engine Loaded');
console.log('ğŸ® 441 Backend Tests Passing | GTA-Grade AI | Ready to Play');
</script>
</body>
</html>
